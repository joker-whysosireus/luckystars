<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Lucky Stars</title>
    
    <link rel="stylesheet" href="index.css">
    
    <!-- Telegram Web App SDK -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>

    <!-- Adexium Widget -->
    <script type="text/javascript">
        // Функция для инициализации Adexium после загрузки DOM
        function initAdexium() {
            if (typeof AdexiumWidget !== 'undefined') {
                try {
                    const adexiumWidget = new AdexiumWidget({
                        wid: 'e279c53e-42c1-42b9-93be-a535d900a92e', 
                        adFormat: 'push-like'
                    });
                    adexiumWidget.autoMode();
                    console.log('Adexium widget initialized successfully');
                    
                    // Сохраняем ссылку на виджет для ручного управления
                    window.adexiumWidget = adexiumWidget;
                } catch (error) {
                    console.error('Adexium initialization error:', error);
                }
            } else {
                console.warn('AdexiumWidget is not defined');
            }
        }

        // Загружаем скрипт Adexium
        function loadAdexiumScript() {
            return new Promise((resolve, reject) => {
                if (document.querySelector('script[src*="adexium-widget"]')) {
                    resolve();
                    return;
                }
                
                const script = document.createElement('script');
                script.src = 'https://cdn.tgads.space/assets/js/adexium-widget.min.js';
                script.type = 'text/javascript';
                script.async = true;
                
                script.onload = () => {
                    console.log('Adexium script loaded');
                    resolve();
                };
                
                script.onerror = () => {
                    console.error('Failed to load Adexium script');
                    reject(new Error('Adexium script load failed'));
                };
                
                document.head.appendChild(script);
            });
        }

        // Инициализация после полной загрузки страницы
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                await loadAdexiumScript();
                // Даем время для загрузки библиотеки
                setTimeout(initAdexium, 1000);
            } catch (error) {
                console.error('Adexium loading failed:', error);
            }
        });

        // Резервная функция для показа рекламы Adexium
        window.showAdexiumAd = function() {
            return new Promise((resolve, reject) => {
                if (window.adexiumWidget && typeof window.adexiumWidget.show === 'function') {
                    try {
                        window.adexiumWidget.show();
                        console.log('Adexium ad shown manually');
                        // Симулируем успешный показ через 2 секунды
                        setTimeout(resolve, 2000);
                    } catch (error) {
                        console.error('Error showing Adexium ad:', error);
                        reject(error);
                    }
                } else {
                    console.warn('Adexium widget not available, using fallback');
                    // Резервное решение
                    setTimeout(resolve, 2000);
                }
            });
        };
    </script>

    <!-- GigaPub SDK -->
    <script data-project-id="3186">
      !function(){
        var s=document.currentScript,p=s.getAttribute('data-project-id')||'default';
        var d=['https://ad.gigapub.tech','https://ru-ad.gigapub.tech'],i=0,t,sc;
        function l(){
          sc=document.createElement('script');
          sc.async=true;
          sc.src=d[i]+'/script?id='+p;
          clearTimeout(t);
          t=setTimeout(function(){
            sc.onload=sc.onerror=null;
            sc.src='';
            if(++i<d.length)l();
          },15000);
          sc.onload=function(){
            clearTimeout(t);
            console.log("GigaPub SDK загружен успешно");
            if (window.gigaOfferWallSDK) {
              window.gigaOfferWallSDK.init({
                projectId: "3186"
              });
              
              window.showGiga = function() {
                return new Promise((resolve, reject) => {
                  if (window.gigaOfferWallSDK && typeof window.gigaOfferWallSDK.open === 'function') {
                    window.gigaOfferWallSDK.open();
                    console.log("GigaPub OfferWall открыт");
                    resolve();
                  } else {
                    const error = "GigaPub SDK недоступен";
                    console.error(error);
                    reject(new Error(error));
                  }
                });
              };
              console.log("GigaPub функция showGiga инициализирована");
            }
          };
          sc.onerror=function(){
            clearTimeout(t);
            console.error("Ошибка загрузки GigaPub с", d[i]);
            if(++i<d.length)l();
          };
          document.head.appendChild(sc);
        }
        l();
      }();
    </script>

    <!-- Резервные функции -->
    <script type="text/javascript">
      // Резервная функция для GigaPub
      window.AdGigaFallback = function() {
        return new Promise((resolve) => {
          console.log("Используем резервную рекламу GigaPub");
          setTimeout(resolve, 1000);
        });
      };

      // Универсальная функция для показа рекламы
      window.showAd = function() {
        return new Promise(async (resolve) => {
          console.log('Attempting to show ad...');
          
          // Сначала пробуем Adexium
          try {
            await window.showAdexiumAd();
            console.log('Adexium ad completed');
            resolve();
            return;
          } catch (error) {
            console.warn('Adexium failed, trying GigaPub:', error);
          }
          
          // Затем пробуем GigaPub
          try {
            if (typeof window.showGiga === 'function') {
              await window.showGiga();
              console.log('GigaPub ad completed');
            } else {
              await window.AdGigaFallback();
              console.log('GigaPub fallback completed');
            }
            resolve();
          } catch (error) {
            console.error('All ad providers failed, using final fallback:', error);
            // Финальное резервное решение
            setTimeout(resolve, 1500);
          }
        });
      };

      // Инициализация резервных функций через 5 секунд
      setTimeout(() => {
        if (typeof window.showGiga !== 'function') {
          console.warn("GigaPub не загрузился, используем резервную функцию");
          window.showGiga = window.AdGigaFallback;
        }
      }, 5000);
    </script>
    
</head>
<body>
    <div id="root"></div>
    <script type="module" src="/src/main.jsx"></script>

    <!-- Дополнительная инициализация после загрузки React -->
    <script type="text/javascript">
        // Проверяем доступность рекламных SDK после загрузки приложения
        window.addEventListener('load', () => {
            setTimeout(() => {
                console.log('Ad availability check:');
                console.log('- Adexium available:', typeof window.adexiumWidget !== 'undefined');
                console.log('- GigaPub available:', typeof window.showGiga === 'function');
                console.log('- Universal ad function available:', typeof window.showAd === 'function');
            }, 2000);
        });
    </script>
</body>
</html>